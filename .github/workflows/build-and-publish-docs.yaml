name: Build and Publish Documentation

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      run_scan:
        description: 'Run jQAssistant scan'
        type: boolean
        required: false
        default: false
      run_analyze:
        description: 'Run jQAssistant analyze'
        type: boolean
        required: false
        default: true
      publish_docs:
        description: 'Publish documents to GitHub Pages'
        type: boolean
        required: false
        default: false

permissions:
  contents: read
  id-token: write
  pages: write

jobs:
  check-artifact:
    runs-on: ubuntu-latest
    outputs:
      should_scan: ${{ ! steps.check_artifact.outputs.exists }}
    steps:
      - name: Check Artifact
        uses: softwareforgood/check-artifact-v4-existence@v0
        id: check_artifact
        with:
          name: jqassistant-store

  jqa-scan:
    needs: check-artifact
    if: ${{ inputs.run_scan || needs.check-artifact.outputs.should_scan }}
    runs-on: ubuntu-latest
    env:
      GITHUB_LOGIN: ${{ github.repository_owner }}
      GITHUB_OAUTH: ${{ github.token }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Run jQAssistant scan
        run: mvn jqassistant:scan -fae -e -ntp -s .github/settings.xml

      - name: Upload jqassistant/store artifact
        uses: actions/upload-artifact@v4
        with:
          name: jqassistant-store
          path: target/jqassistant/store
  
  jqa-analyze:
    if: ${{ inputs.run_analyze }}
    needs: jqa-scan
    runs-on: ubuntu-latest
    env:
      GITHUB_LOGIN: ${{ github.repository_owner }}
      GITHUB_OAUTH: ${{ github.token }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Download jqassistant/store artifact
        uses: actions/download-artifact@v4
        with:
          name: jqassistant-store
          path: target/jqassistant/store

      - name: Run jQAssistant analyze and generate docs
        run: mvn jqassistant:analyze asciidoctor:process-asciidoc -fae -e -ntp -s .github/settings.xml

      - name: Upload Generated Documentation
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: target/generated-docs
  
  publish-docs:
    needs: jqa-analyze
    if: ${{ inputs.publish_docs || github.ref_name == 'main' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download generated-docs artifact
        uses: actions/download-artifact@v4
        with:
          name: generated-docs
          path: target/generated-docs
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/generated-docs
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4